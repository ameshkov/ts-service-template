services:
  dind:
    image: docker:dind
    container_name: microservice-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ''
    volumes:
      - dind-storage:/var/lib/docker
    healthcheck:
      test: ['CMD', 'docker', 'info']
      interval: 5s
      timeout: 5s
      retries: 5

  builder:
    image: docker:cli
    container_name: microservice-builder
    depends_on:
      dind:
        condition: service_healthy
    environment:
      DOCKER_HOST: tcp://dind:2375
    volumes:
      - .:/workspace
      - ./output:/output
    working_dir: /workspace
    command: >
      docker build
        --progress plain
        --network=host
        --build-arg DOCKER_HOST=tcp://dind:2375
        --output type=local,dest=/output
        --target tester-output
        .

volumes:
  dind-storage:
